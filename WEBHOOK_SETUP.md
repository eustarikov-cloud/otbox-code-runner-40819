# Настройка webhook для отправки файлов после оплаты

## 1. Настройка webhook в YooKassa

1. Войдите в личный кабинет YooKassa: https://yookassa.ru/my
2. Перейдите в раздел **Настройки** → **Уведомления**
3. Добавьте HTTP-уведомление со следующими параметрами:
   - **URL**: `https://ptsrzvbrvopdjtgtstzg.supabase.co/functions/v1/yookassa-webhook`
   - **События**: выберите `payment.succeeded` (Успешный платеж)
   - **Формат**: JSON
4. Сохраните настройки

## 2. Загрузка файлов в хранилище

Файлы должны быть загружены в Supabase Storage в bucket `digital-files`:

1. Откройте Cloud панель в Lovable
2. Перейдите в раздел **Files** (Хранилище)
3. Выберите bucket `digital-files`
4. Загрузите файлы с именами, соответствующими `file_path` в таблице `products`:
   - Для `office-package`: загрузите файл по пути из поля `file_path`
   - Для `salon-package`: загрузите файл по пути из поля `file_path`

## 3. Проверка настроек продуктов

Убедитесь, что в таблице `products` для каждого товара указан правильный `file_path`:

```sql
SELECT sku, title, file_path, is_active FROM products;
```

## 4. Тестирование

После настройки webhook:
1. Создайте тестовый платеж через форму на сайте
2. Оплатите через YooKassa
3. После успешной оплаты проверьте:
   - Email должен прийти автоматически
   - В письме должна быть активная ссылка на скачивание
   - Ссылка действительна 120 минут

## 5. Просмотр логов

Логи webhook можно просмотреть в Cloud панели:
- Перейдите в **Edge Functions**
- Выберите функцию `yookassa-webhook`
- Откройте вкладку **Logs**

## Технические детали

- Webhook автоматически:
  - Получает уведомление от YooKassa о успешной оплате
  - Находит продукт по SKU
  - Генерирует временную ссылку на скачивание (действует 120 минут)
  - Создает запись в таблице `orders`
  - Отправляет письмо через Resend с ссылкой на скачивание

- Email отправляется с адреса, указанного в переменной `FROM_EMAIL` (по умолчанию: `OT-Box <no-reply@otbox.ru>`)
